{"ast":null,"code":"export const translateSrt = async (fileContent, apiKey, language) => {\n  const maxRetries = 5; // Maximum retries before giving up\n  let retryDelay = 2000; // Initial delay is 2 seconds\n  let retryCount = 0;\n\n  // Keep trying until the max retry limit is reached\n  while (retryCount < maxRetries) {\n    try {\n      var _data$choices, _data$choices$, _data$choices$$messag;\n      console.log(\"Sending translation request...\");\n\n      // Send the translation request\n      let response = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${apiKey}`\n        },\n        body: JSON.stringify({\n          model: \"gpt-3.5-turbo\",\n          messages: [{\n            role: \"system\",\n            content: `You are an SRT translator. Translate the following subtitles to ${language}:`\n          }, {\n            role: \"user\",\n            content: fileContent\n          }]\n        })\n      });\n\n      // Check for 429 Rate Limit Exceeded response\n      while (response.status === 429) {\n        const retryAfter = response.headers.get(\"Retry-After\");\n        const waitTime = retryAfter ? parseInt(retryAfter, 10) * 1000 : retryDelay;\n        console.warn(`Rate limit exceeded. Retrying in ${waitTime / 1000} seconds...`);\n        await new Promise(resolve => setTimeout(resolve, waitTime)); // Wait before retrying\n        retryDelay *= 2; // Exponential backoff: double the delay for the next retry\n        retryCount++;\n\n        // Retry the request after the delay\n        response = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            Authorization: `Bearer ${apiKey}`\n          },\n          body: JSON.stringify({\n            model: \"gpt-3.5-turbo\",\n            messages: [{\n              role: \"system\",\n              content: `You are an SRT translator. Translate the following subtitles to ${language}:`\n            }, {\n              role: \"user\",\n              content: fileContent\n            }]\n          })\n        });\n\n        // If retry count exceeds max retries, throw an error\n        if (retryCount >= maxRetries) {\n          console.error(\"Max retries exceeded for rate limit.\");\n          throw new Error(\"Rate limit exceeded.\");\n        }\n      }\n\n      // Handle response if status is not 429\n      if (!response.ok) {\n        console.error(\"API Request Failed:\", response.statusText);\n        throw new Error(`API Request failed with status ${response.status}`);\n      }\n\n      // Parse the API response\n      const data = await response.json();\n      console.log(\"Full API Response:\", data);\n      const translatedText = (data === null || data === void 0 ? void 0 : (_data$choices = data.choices) === null || _data$choices === void 0 ? void 0 : (_data$choices$ = _data$choices[0]) === null || _data$choices$ === void 0 ? void 0 : (_data$choices$$messag = _data$choices$.message) === null || _data$choices$$messag === void 0 ? void 0 : _data$choices$$messag.content) || null;\n\n      // Display the translated text to verify the response\n      if (translatedText) {\n        console.log(\"Translation Success:\", translatedText);\n        return translatedText;\n      } else {\n        console.error(\"No translation found in the response.\");\n        throw new Error(\"No translation found in the response.\");\n      }\n    } catch (error) {\n      console.error(\"Translation Error:\", error);\n\n      // If max retries are reached, throw an error\n      if (retryCount === maxRetries - 1) {\n        throw new Error(\"Max retries reached. Translation failed.\");\n      }\n    }\n  }\n  return null; // If all retries fail\n};","map":{"version":3,"names":["translateSrt","fileContent","apiKey","language","maxRetries","retryDelay","retryCount","_data$choices","_data$choices$","_data$choices$$messag","console","log","response","fetch","method","headers","Authorization","body","JSON","stringify","model","messages","role","content","status","retryAfter","get","waitTime","parseInt","warn","Promise","resolve","setTimeout","error","Error","ok","statusText","data","json","translatedText","choices","message"],"sources":["/home/user/srt-translator/src/utils/translateSrt.ts"],"sourcesContent":["export const translateSrt = async (\n  fileContent: string,\n  apiKey: string,\n  language: string\n): Promise<string | null> => {\n  const maxRetries = 5; // Maximum retries before giving up\n  let retryDelay = 2000; // Initial delay is 2 seconds\n  let retryCount = 0;\n\n  // Keep trying until the max retry limit is reached\n  while (retryCount < maxRetries) {\n    try {\n      console.log(\"Sending translation request...\");\n\n      // Send the translation request\n      let response = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${apiKey}`,\n        },\n        body: JSON.stringify({\n          model: \"gpt-3.5-turbo\",\n          messages: [\n            {\n              role: \"system\",\n              content: `You are an SRT translator. Translate the following subtitles to ${language}:`,\n            },\n            { role: \"user\", content: fileContent },\n          ],\n        }),\n      });\n\n      // Check for 429 Rate Limit Exceeded response\n      while (response.status === 429) {\n        const retryAfter = response.headers.get(\"Retry-After\");\n        const waitTime = retryAfter ? parseInt(retryAfter, 10) * 1000 : retryDelay;\n        console.warn(`Rate limit exceeded. Retrying in ${waitTime / 1000} seconds...`);\n\n        await new Promise(resolve => setTimeout(resolve, waitTime)); // Wait before retrying\n        retryDelay *= 2; // Exponential backoff: double the delay for the next retry\n        retryCount++;\n\n        // Retry the request after the delay\n        response = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            Authorization: `Bearer ${apiKey}`,\n          },\n          body: JSON.stringify({\n            model: \"gpt-3.5-turbo\",\n            messages: [\n              {\n                role: \"system\",\n                content: `You are an SRT translator. Translate the following subtitles to ${language}:`,\n              },\n              { role: \"user\", content: fileContent },\n            ],\n          }),\n        });\n\n        // If retry count exceeds max retries, throw an error\n        if (retryCount >= maxRetries) {\n          console.error(\"Max retries exceeded for rate limit.\");\n          throw new Error(\"Rate limit exceeded.\");\n        }\n      }\n\n      // Handle response if status is not 429\n      if (!response.ok) {\n        console.error(\"API Request Failed:\", response.statusText);\n        throw new Error(`API Request failed with status ${response.status}`);\n      }\n\n      // Parse the API response\n      const data = await response.json();\n      console.log(\"Full API Response:\", data);\n\n      const translatedText = data?.choices?.[0]?.message?.content || null;\n\n      // Display the translated text to verify the response\n      if (translatedText) {\n        console.log(\"Translation Success:\", translatedText);\n        return translatedText;\n      } else {\n        console.error(\"No translation found in the response.\");\n        throw new Error(\"No translation found in the response.\");\n      }\n\n    } catch (error) {\n      console.error(\"Translation Error:\", error);\n\n      // If max retries are reached, throw an error\n      if (retryCount === maxRetries - 1) {\n        throw new Error(\"Max retries reached. Translation failed.\");\n      }\n    }\n  }\n\n  return null; // If all retries fail\n};\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}